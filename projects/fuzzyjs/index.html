<!DOCTYPE html>
<html>
<head>
    <title>Fuzzy JS</title>
    <link rel="stylesheet" type="text/css" href="../../css/styles.css">
    <link rel="stylesheet" type="text/css" href="css/styles.css">
    <script type="text/javascript" src="../../js/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="js/fuzzy.min.js"></script>
    <script type="text/javascript" src="js/load-image.min.js"></script>
    <script>
        window.onload = function() {            
            var
                myImg = $("#myImage")[0],
                canvas = document.createElement("canvas"),
                colorFilterImg = document.createElement('img'),
                maxAttempts = 5,
                attempts = 0,
                maxSampleImgHeight = 118,
                ctx,
                newImage;
            
            canvas.width = myImg.width;
            canvas.height = myImg.height;
            ctx = canvas.getContext("2d");
            
            // setup file picked handler
            $("#file-input").change(function(e) {
            	newImage = loadImage(
            		e.target.files[0],
            		function (i) {
            			// change the image and re-run the demo
            			i.id = "myImage";
            			$("#myImage").replaceWith(i)
            			runDemo($("#myImage")[0]);
            		},
            		{ maxWidth: 250,
            		  maxHeight: 178 }
            	);
            });
            
            /* 
             * Set up the on hover popup
             */
            var setupHoverPopup = function (imgToMouseOver, imgToScale, width, height) {
            	// scale the image and store the larger one
            	var enlargedImage = fuzzy(imgToScale).scale(width, height), topMargin, leftMargin;
            	
            	// When the enlarged image is loaded, set up the mousemove/mouseleave handlers
            	waitForImgLoad(enlargedImage, function () {
            		// on mousemove, display the enlarged image div near the cursor		        	
		        	$(imgToMouseOver).mousemove(function (event) {
		        		if($("#enlarge").attr("src") !== enlargedImage.src) {
		        			$("#enlarge").attr("src", enlargedImage.src);
		        		}
		        		
		        		if((event.clientY + enlargedImage.height + 35) > window.innerHeight) {
	        				topMargin = event.pageY - enlargedImage.height - 35;
	        			}
	        			else {
	        				topMargin = event.pageY + 35;
	        			}
	        			
	        			if((event.clientX + enlargedImage.width + 45) > window.innerWidth) {
	        				leftMargin = event.pageX - enlargedImage.width - 45;
	        			}
	        			else {
	        				leftMargin = event.pageX + 45;
	        			}
	        			
		        		$("#enlarge").css({
		        			top: topMargin,
		        			left: leftMargin
		        		}).addClass("enlarge-show");
		        	});
		        	
		        	// on mouseleave, hide the popup div
		        	$(imgToMouseOver).mouseleave(function (event) {
		        		$("#enlarge").css("left", "-1000").removeClass("enlarge-show");
		        	});
            	});
            };
            
            /*
             * Setups the timer to run the image processing
             */
            var runDemoTimer = function(func) {
            	window.setTimeout(func, 0);
            }
            
            /*
             * The main demo function
             * Run the demo from the image given
             */
            var demo = function(image) {
            	try {
            		canvas.width = image.width;
            		canvas.height = image.height;
                	ctx.drawImage(image, 0, 0, image.width, image.height);
               	}
               	catch (e) {
               		// There seems to be an issue in Mozilla where this error is thrown at times
               		// when drawImage() is called even when the image is supposedly loaded. Just keep trying a few times if we get this error.
               		if(e.name === 'NS_ERROR_NOT_AVAILABLE' && attempts < maxAttempts) {
               			attempts++;
	               		window.setTimeout(function () {
	               			runDemo(image);
	               		},100);
	               		return;
               		}
               	}
               	
               	attempts = 0;
               	
               	// color filter demo
               	runDemoTimer(function () {
	                fuzzy(canvas).colorFilter(fuzzy.colorFilters.RED).draw(null,
	                	{
	                		// callback function to chnage the sample image and setup the popup hover image
	                		callback: function (i) {
	                			var 
	                				element = $("#color-filter").children().first(),
	                				newImageElement = document.createElement('img');
	                				
	                			newImageElement.className = "sample";
	                			newImageElement.height = maxSampleImgHeight;
	                			newImageElement.style.width = 'auto';
	                			newImageElement.src = i.src;
	                			
	                			// Place the new sample image
	                			if(element.attr("src") !== undefined) {
	                				element.replaceWith(newImageElement);
	                			}
	                			else {
	                				$(newImageElement).insertBefore(element);
	                			}
	                			
	                			// When 'i' is loaded, setup the popup
	                			waitForImgLoad(i, function () {
	            					setupHoverPopup(newImageElement, i, newImageElement.style.width * 3, maxSampleImgHeight * 3);
	            				});
	                		}
	                	});
                });
                
                // invert filter sample - place into the given image
                runDemoTimer(function () {
	                fuzzy(canvas).invert().draw($("#inverted")[0],
	                	{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#inverted")[0], im, $("#inverted")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
                });
                
                // invert filter with a color filter
                runDemoTimer(function () {
                fuzzy(canvas).invert(fuzzy.colorFilters.RED).draw($("#inverted-color")[0],
                	{
                		// setups the popup
                		callback: function (i) {
                			waitForImgLoad(i, function(im) {
                				setupHoverPopup($("#inverted-color")[0], im, $("#inverted-color")[0].width * 3, maxSampleImgHeight * 3);
                			});
                		}
                	});
                });
                
                // greyscale filter
                runDemoTimer(function () {
                fuzzy(canvas).greyscale().draw($("#greyscale")[0],
                	{
                		// setups the popup
                		callback: function (i) {
                			waitForImgLoad(i, function(im) {
                				setupHoverPopup($("#greyscale")[0], im, $("#greyscale")[0].width * 3, maxSampleImgHeight * 3);
                			});
                		}
                	});
                });
                
                // pixelate filter
                runDemoTimer(function () {
                fuzzy(image).pixelate(5).draw($("#pixelate")[0],
                	{
                		// setups the popup
                		callback: function (i) {
                			waitForImgLoad(i, function(im) {
                				setupHoverPopup($("#pixelate")[0], im, $("#pixelate")[0].width * 3, maxSampleImgHeight * 3);
                			});
                		}
                	});
                });
                
                // box blur filter
                runDemoTimer(function () {
                fuzzy(canvas).boxBlur(3).draw($("#box-blur")[0],
                	{
                		// setups the popup
                		callback: function (i) {
                			waitForImgLoad(i, function(im) {
                				setupHoverPopup($("#box-blur")[0], im, $("#box-blur")[0].width * 3, maxSampleImgHeight * 3);
                			});
                		}
                	});
                });
                
                // horizontal motion blur
                runDemoTimer(function () {
	            	fuzzy(canvas).motionBlur(8).draw($("#h-blur")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#h-blur")[0], im, $("#h-blur")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
                });
                	
            	// vertical motion blur
            	runDemoTimer(function () {
	            	fuzzy(canvas).motionBlur(8, fuzzy.directions.VERTICAL).draw($("#v-blur")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#v-blur")[0], im, $("#v-blur")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
              	});
                	
                // emboss filter
                runDemoTimer(function () {
	            	fuzzy(canvas).emboss().draw($("#emboss")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#emboss")[0], im, $("#emboss")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
                });
                
                // change luminosity - darker
                runDemoTimer(function () {
	            	fuzzy(canvas).luminosity(0.5).draw($("#darken")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#darken")[0], im, $("#darken")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
                });
            	
            	// change luminosity - brighter
            	runDemoTimer(function () {
	            	fuzzy(canvas).luminosity(1.5).draw($("#lighten")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#lighten")[0], im, $("#lighten")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
              	});
                
                // sharpen filter
                runDemoTimer(function () {
	            	fuzzy(canvas).sharpen().draw($("#sharpen")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#sharpen")[0], im, $("#sharpen")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
                });
                
                // edge trace filter
                runDemoTimer(function () {
	            	fuzzy(canvas).edgetrace().draw($("#edge")[0],
	            		{
	                		// setups the popup
	                		callback: function (i) {
	                			waitForImgLoad(i, function(im) {
	                				setupHoverPopup($("#edge")[0], im, $("#edge")[0].width * 3, maxSampleImgHeight * 3);
	                			});
	                		}
	                	});
                });
            };
            
            /*
             * Waits for the given image to be loaded.
             * When loaded, it calls the given function and passes through the image
             */
            var waitForImgLoad = function (i, func) {
            	if(i.complete) {
            		func(i);
            	}
            	else {
            		$(i).load(function () {
            			func(i);
            		});
            	}
            };
            
            // Runs the demo
            var runDemo = function (i) {
            	waitForImgLoad(i, demo);
            };
            
            // initial demo run
            runDemo(myImg);
        }
    </script>
</head>
<body>
	<img id="enlarge" />
    <div class="main-content-container">
        <div class="container header">
            <div class="content-container">
                <div class="section group">
                    <div class="col span_4_of_6">
                        <h1>Fuzzy JS</h1>
                        <h5 class="subtitle">A simple image processing JavaScript library</h5>
                    </div>
                    <div class="col span_2_of_6">
                        <img id="myImage" src="assets/fuzzy.jpg" width="250" height="178" />
                        <form action="" method="post" enctype="multipart/form-data">
                        	<div class="upload">
                        		<input type="file" id="file-input" />
                        	</div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="container samples">
            <div class="content-container">
                <div class="section group">
                    <h2>Filters</h2>
                    <h5 class="subtitle">Quick and simple filters</h5>
                </div>
                <div class="section group">
                    <div class="col span_1_of_4" id="color-filter">
                        <div>Color filter</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="inverted" class="sample" height="118" />
                        <div>Inverted</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="inverted-color" class="sample" height="118" />
                        <div>Inverter w/ color filter</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="greyscale" class="sample" height="118" />
                        <div>Greyscale</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container samples">
            <div class="content-container">
                <div class="section group">
                    <h2>Blurs</h2>
                    <h5 class="subtitle">Various blurs</h5>
                </div>
                <div class="section group">
                    <div class="col span_1_of_4">
                        <img id="pixelate" class="sample" height="118" />
                        <div>Pixelate</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="box-blur" class="sample" height="118" />
                        <div>Box blur</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="h-blur" class="sample" height="118" />
                        <div>Horizontal blur</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="v-blur" class="sample" height="118" />
                        <div>Vertical blur</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container samples">
            <div class="content-container">
                <div class="section group">
                    <h2>Extra</h2>
                    <h5 class="subtitle">Various other image processing tools</h5>
                </div>
                <div class="section group">
                    <div class="col span_1_of_4">
                        <img id="emboss" class="sample" height="118" />
                        <div>Emboss</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="darken" class="sample" height="118" />
                        <div>Darken</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="lighten" class="sample" height="118" />
                        <div>Lighten</div>
                    </div>
                    <div class="col span_1_of_4">
                        <img id="sharpen" class="sample" height="118" />
                        <div>Sharpen</div>
                    </div>
                </div>
                <div class="section group">
                    <div class="col span_1_of_4">
                        <img id="edge" class="sample" height="118" />
                        <div>Edge trace</div>
                    </div>
                </div> 
            </div>
        </div>

        <div class="container footer">
            <div class="content-container">
                <div class="section group">
                    <ul class="footer-links">
                        <li class="col span_5_of_6">Built by Armando Locay, 2014. Licensed under the MIT License.</li>
                        <li class="col span_1_of_6"><a href="https://github.com/alocay/Fuzzy">GitHub</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
