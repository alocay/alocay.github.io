<html>
	<head>
        <link rel="stylesheet" type="text/css" href="css/style.css">
		<script type="text/javascript" src="js/jquery-1.11.1.min.js"></script>
		<script type="text/javascript" src="js/paper-full.js"></script>
        <script type="text/javascript" src="js/extends.js"></script>
        <script type="text/javascript" src="js/environment.js"></script>
        <script type="text/javascript" src="js/mob.js"></script>
        <script type="text/javascript" src="js/enemy.js"></script>
        <script type="text/javascript" src="js/player.js"></script>
		<script type="text/javascript">
            paper.install(window);
            $(document).ready(function () {
                var canvas = document.getElementById('canvas');
                //var gui = new dat.GUI();
                var fieldPaths = [];
                var shiftDown = false;
                var ctrlDown = false;
				var mouseDown = false;
				var moveLight = false;
				var visible = [];
				var intersections = [];
				var lines = [];
				var markers = [];
				var blocks = [];
				var testLines = [];
				var areaPoints = [];
				var area = null;
				var fails = [];
				var mask = null;
				var fov = 60; 
				var fovCenter = null;
				var direction = new Point(0, 100);
				var movementAmount = 10;
				var enemies = [];
				var nv = null;
				var rv = null;
				var tv = null;
				var targetLocation = null;
				var pVector = new Point();
				var distThreshold = 1;
				var lockView = false;
				
				window.DEBUG_GAME = true;
				
                paper.setup(canvas);
				
                var tool = new Tool();
				
				var environment = new Environment(view.size);
				
                var player = new Player(new Point(350, 200), 10);
                var enemy = new Enemy(new Point(100,100), 5);
                enemy.vector = new Point(50,50);
                
                environment.player = player;
                environment.enemies.push(enemy);
				
				var block = new Rectangle(new Point (200, 0), new Size(100, view.size.height - 200));
				var block2 = new Rectangle(new Point(400, 0), new Size(100, view.size.height - 200));
				var block3 = new Rectangle(new Point(400, view.size.height - 200), new Size(500, 50));
				
				var blockPath1 = new Path.Rectangle(block);
				var blockPath2 = new Path.Rectangle(block2);
				var blockPath3 = new Path.Rectangle(block3);
                
                environment.addObstacle(blockPath1);
                environment.addObstacle(blockPath2);
                environment.addObstacle(blockPath3);
                environment.addObstacle(new Path.Circle(new Point(350, 400), 15));
				
				/*function drawMarkers() {					
					while(markers.length > 0) {
                        markers.pop().remove();
                    }
					
					for (var i = 0; i < visible.length; i++) {
						var b = new Shape.Circle(visible[i], 3);
						b.fillColor = 'blue';
						markers.push(b);
					}
					
					for (var i = 0; i < fails.length; i++) {
						var b = new Shape.Circle(fails[i], 3);
						b.fillColor = 'red';
						markers.push(b);
					}
				}
				
				function drawArrow(start, end, d) {
					var b = d.normalize(3);
					var p1 = new Path([start, end]);
					p1.strokeColor = 'black';
					
					var p2 = new Path([end.add(b.rotate(135)), end, end.add(b.rotate(-135))]);
					p2.strokeColor = 'black';
					
					var vi = new Group([p1, p2]);
					return vi;
				}
                
				function removeArrow(arrow) {
					if (!arrow) {
						return;
					}
					
					var c = arrow.removeChildren();
					for (var j = 0; j < c.length; j++) {
						c[j].remove();
					}
					
					arrow.remove();
				};*/
				
                tool.onKeyDown = function(event) {
                    
                    if (event.key == 'shift') {
                        shiftDown = true;
                    }
                    
                    if (event.key == 'control') {
                        ctrlDown = true;
                    }
					
					var p = environment.player;
					if (event.key == 'a') {
						var v = p.visionVector.rotate(90).normalize(movementAmount);
                        p.move(environment, p.position.add(v));
					}
					
					if (event.key == 'w') {
						var v = p.visionVector.normalize(movementAmount);
                        p.move(environment, p.position.add(v));
					}
					
					if (event.key == 's') {
						var v = p.visionVector.multiply(-1).normalize(movementAmount);
                        p.move(environment, p.position.add(v));
					}
					
					if(event.key == 'd') {
						var v = p.visionVector.rotate(-90).normalize(movementAmount);
                        p.move(environment, p.position.add(v));
					}
                }

                tool.onKeyUp = function(event) {
                    if (event.key == 'shift') {
                        shiftDown = false;
						lockView = !lockView;
                    }
					
					if (event.key == 'control') {
						ctrlDown = false;
					}
                }
                
                tool.onMouseUp = function(evt) {
					mouseDown = false;
					environment.player.targetLocation = evt.point;
                };
				
				tool.onMouseDown = function(evt) {
					mouseDown = true;
				};
				
				tool.onMouseMove = function(evt) {
					if (!lockView) {
						environment.player.setVisionVector(evt.point);
					}
					
					if (mouseDown) {
						environment.player.targetLocation = evt.point;
					}
				};
				
				tool.onMouseDrag = function(evt) {
				};
				
                // Draw the view now:
                view.onFrame = function(evt) {
					environment.update();
                }
				
                paper.view.draw();
            });
		</script>
	</head>
	<body>
		<div id="container">
            <canvas id="canvas"></canvas>
        </div>
	<body>
</html>